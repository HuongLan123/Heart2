<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>V≈© tr·ª• tr√°i tim - MINH IT</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: black;
    overflow: hidden;
    height: 100%;
  }
  canvas {
    position: absolute;
    width: 100%;
    height: 100%;
  }
  #starCanvas { z-index: -1; }      /* n·ªÅn sao */
  #heartCanvas { z-index: 0; }      /* v√≤ng ch·ªØ tim */
  #pinkboard { z-index: 1; pointer-events: none; } /* tim l·ªõn */
  #flyingHearts { z-index: 2; pointer-events: none; } /* tim bay */

  /* üéµ N√∫t ƒëi·ªÅu khi·ªÉn nh·∫°c */
  #musicControl {
    position: fixed;
    bottom: 20px;
    right: 25px;
    z-index: 100;
    background: rgba(255, 192, 203, 0.25);
    border: 2px solid #ff99cc;
    border-radius: 50%;
    width: 55px;
    height: 55px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 0 15px #ff99cc;
    transition: all 0.3s;
  }
  #musicControl:hover {
    transform: scale(1.15) rotate(10deg);
    box-shadow: 0 0 25px #ff66cc;
  }
  #musicControl svg {
    width: 28px;
    height: 28px;
    fill: #ff99cc;
  }
</style>
</head>
<body>

<!-- üåå N·ªÅn sao -->
<canvas id="starCanvas"></canvas>

<!-- üíû V√≤ng tr√°i tim + tr√°i tim l·ªõn -->
<canvas id="heartCanvas"></canvas>
<canvas id="pinkboard"></canvas>

<!-- üí´ Tim nh·ªè bay l√™n -->
<canvas id="flyingHearts"></canvas>

<!-- üéµ Nh·∫°c n·ªÅn -->
<audio id="bgMusic" loop>
  <source src="love.mp3" type="audio/mpeg">
  Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ √¢m thanh.
</audio>

<!-- üîò N√∫t b·∫≠t/t·∫Øt nh·∫°c -->
<div id="musicControl" title="B·∫≠t/T·∫Øt nh·∫°c">
  <svg id="musicIcon" viewBox="0 0 24 24">
    <path d="M12 3v10.55A4 4 0 1 0 14 17V7h4V3h-6z"/>
  </svg>
</div>

<script>
/* =====================================
   üåå PH·∫¶N 0: N·ªÄN SAO
===================================== */
const starCanvas = document.getElementById("starCanvas");
const starCtx = starCanvas.getContext("2d");
let sw, sh;
function resizeStar() {
  sw = starCanvas.width = window.innerWidth;
  sh = starCanvas.height = window.innerHeight;
}
resizeStar();
window.addEventListener("resize", resizeStar);

const stars = Array.from({ length: 250 }, () => ({
  x: Math.random() * sw,
  y: Math.random() * sh,
  size: Math.random() * 2,
  alpha: Math.random(),
  twinkleSpeed: 0.02 + Math.random() * 0.03
}));

function drawStars() {
  starCtx.clearRect(0, 0, sw, sh);
  for (const s of stars) {
    s.alpha += (Math.random() - 0.5) * s.twinkleSpeed;
    if (s.alpha < 0) s.alpha = 0;
    if (s.alpha > 1) s.alpha = 1;
    starCtx.globalAlpha = s.alpha;
    starCtx.fillStyle = "#fff";
    starCtx.beginPath();
    starCtx.arc(s.x, s.y, s.size, 0, 2 * Math.PI);
    starCtx.fill();
  }
}

/* =====================================
   üíû PH·∫¶N 1: V√íNG CH·ªÆ TR√ÅI TIM
===================================== */
const canvasR = document.getElementById("heartCanvas");
const ctxR = canvasR.getContext("2d");
let w, h;

function resizeR() {
  w = canvasR.width = window.innerWidth;
  h = canvasR.height = window.innerHeight;
}
resizeR();
window.addEventListener("resize", resizeR);

const tiltAngle = 40 * Math.PI / 180;
const ringTexts = ["Ch√∫c h·ªôi ph·∫£i gi·∫£i t√°n trung thu vui v·∫ª", "Ch√∫c H·ªôi 8386 m√£i ƒë·ªânh", "manifest c√°c ph√∫ b√†"];
const rings = [];

for (let r = 0; r < ringTexts.length; r++) {
  const ring = {
    hearts: [],
    text: ringTexts[r],
    currentRadius: 0,
    targetRadius: Math.min(w, h) * (0.16 + r * 0.1),
    growing: true,
    appearTime: r * 3000,
    started: false,
    rotation: Math.random() * Math.PI * 2
  };

  const numHearts = 200;
  const textArcFraction = 0.25;
  const startTextAngle = Math.random() * Math.PI * 2;
  const endTextAngle = startTextAngle + 2 * Math.PI * textArcFraction;

  for (let i = 0; i < numHearts; i++) {
    const angle = (i / numHearts) * 2 * Math.PI;
    if (angle < startTextAngle || angle > endTextAngle) {
      ring.hearts.push({ angle, flicker: Math.random() * 2 * Math.PI });
    }
  }

  ring.textStart = startTextAngle;
  ring.textEnd = endTextAngle;
  rings.push(ring);
}

function drawHeartR(x, y, size, color, alpha) {
  ctxR.save();
  ctxR.translate(x, y);
  ctxR.scale(size, size);
  ctxR.beginPath();
  ctxR.moveTo(0, -3);
  ctxR.bezierCurveTo(2, -6, 6, -2, 0, 5);
  ctxR.bezierCurveTo(-6, -2, -2, -6, 0, -3);
  ctxR.closePath();
  ctxR.globalAlpha = alpha;
  ctxR.fillStyle = color;
  ctxR.fill();
  ctxR.restore();
}

function drawTextArcR(text, radius, startAngle, endAngle, rotation) {
  ctxR.save();
  ctxR.translate(w / 2, h / 2 + 150);
  ctxR.rotate(rotation);
  ctxR.scale(1, Math.cos(tiltAngle));
  ctxR.fillStyle = "#ffccdd";
  ctxR.font = "bold 22px Arial";
  ctxR.textAlign = "center";
  ctxR.textBaseline = "middle";

  const textLength = text.length;
  const arcLength = endAngle - startAngle;
  const step = arcLength / (textLength - 1);

  for (let i = 0; i < textLength; i++) {
    const angle = startAngle + i * step;
    const x = Math.cos(angle) * radius;
    const y = Math.sin(angle) * radius;
    ctxR.save();
    ctxR.translate(x, y);
    ctxR.rotate(angle + Math.PI / 2);
    ctxR.fillText(text[i], 0, 0);
    ctxR.restore();
  }
  ctxR.restore();
}

/* =====================================
   üíó PH·∫¶N 2: TR√ÅI TIM L·ªöN
===================================== */
const canvasH = document.getElementById("pinkboard");
const ctxH = canvasH.getContext("2d");

function resizeH() {
  canvasH.width = window.innerWidth;
  canvasH.height = window.innerHeight;
}
resizeH();
window.addEventListener("resize", resizeH);

function pointOnHeart(t) {
  return {
    x: 16 * Math.pow(Math.sin(t), 3),
    y: -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t))
  };
}

const HEART_SCALE = 15;
const PARTICLE_COUNT = 7000;
const particles = [];
const bpm = 20;
const beatPeriod = 60 / bpm;
let start = performance.now();

function randomPointInHeart() {
  let t, p;
  do {
    t = Math.random() * Math.PI * 2 - Math.PI;
    const r = Math.random();
    p = pointOnHeart(t);
    p.x *= HEART_SCALE * Math.pow(r, 1/2);
    p.y *= HEART_SCALE * Math.pow(r, 1/2);
  } while (Math.abs(p.x) < 1 && Math.abs(p.y) < 1);
  return p;
}

for (let i = 0; i < PARTICLE_COUNT; i++) {
  const p = randomPointInHeart();
  p.angle = Math.atan2(p.y, p.x) + (Math.random() - 0.5) * 0.5;
  particles.push(p);
}

/* =====================================
   üí´ PH·∫¶N 3: TIM NH·ªé BAY
===================================== */
const flyingCanvas = document.getElementById("flyingHearts");
const flyingCtx = flyingCanvas.getContext("2d");

function resizeFlying() {
  flyingCanvas.width = window.innerWidth;
  flyingCanvas.height = window.innerHeight;
}
resizeFlying();
window.addEventListener("resize", resizeFlying);

const flyingHearts = [];
for (let i = 0; i < 40; i++) {
  flyingHearts.push({
    x: Math.random() * window.innerWidth,
    y: window.innerHeight + Math.random() * 200,
    size: 10 + Math.random() * 8,
    speed: 0.8 + Math.random() * 1.5,
    alpha: 0.6 + Math.random() * 0.4
  });
}

function drawFlyingHearts() {
  flyingCtx.clearRect(0, 0, flyingCanvas.width, flyingCanvas.height);
  for (const h of flyingHearts) {
    h.y -= h.speed;
    if (h.y < -50) {
      h.y = window.innerHeight + Math.random() * 100;
      h.x = Math.random() * window.innerWidth;
    }
    flyingCtx.save();
    flyingCtx.translate(h.x, h.y);
    flyingCtx.scale(h.size / 20, h.size / 20);
    flyingCtx.beginPath();
    flyingCtx.moveTo(0, -3);
    flyingCtx.bezierCurveTo(2, -6, 6, -2, 0, 5);
    flyingCtx.bezierCurveTo(-6, -2, -2, -6, 0, -3);
    flyingCtx.closePath();
    flyingCtx.globalAlpha = h.alpha;
    flyingCtx.fillStyle = "#ff88cc";
    flyingCtx.fill();
    flyingCtx.restore();
  }
}

/* =====================================
   üí• PH·∫¶N 4: RENDER
===================================== */
function render(time) {
  drawStars();

  // v√≤ng ch·ªØ tim
  ctxR.clearRect(0, 0, w, h);
  const currentTime = time || 0;
  for (const ring of rings) {
    if (currentTime >= ring.appearTime) ring.started = true;
    if (!ring.started) continue;
    if (ring.growing) {
      ring.currentRadius += 0.6;
      if (ring.currentRadius >= ring.targetRadius) ring.growing = false;
    }
    ring.rotation += 0.0012;
    ctxR.save();
    ctxR.translate(w / 2, h / 2 + 150);
    ctxR.scale(1, Math.cos(tiltAngle));
    for (const p of ring.hearts) {
      const angle = p.angle + ring.rotation;
      const x = Math.cos(angle) * ring.currentRadius;
      const y = Math.sin(angle) * ring.currentRadius;
      const twinkle = 0.7 + 0.3 * Math.sin(Date.now() * 0.004 + p.flicker);
      drawHeartR(x, y, 1.2, "#ff99cc", twinkle);
    }
    ctxR.restore();
    drawTextArcR(ring.text, ring.currentRadius, ring.textStart + ring.rotation, ring.textEnd + ring.rotation, 0);
  }

  // tim l·ªõn ƒë·∫≠p
  const t = time / 1000;
  const beatPos = ((t - start / 1000) % beatPeriod) / beatPeriod;
  const pulse = 0.5 + 0.5 * Math.sin(beatPos * 2 * Math.PI);
  ctxH.clearRect(0, 0, canvasH.width, canvasH.height);
  const hue = 330 + Math.sin(t * 3) * 15;
  const color = `hsl(${hue}, 100%, ${45 + pulse * 25}%)`;

  ctxH.save();
  ctxH.translate(canvasH.width / 2, canvasH.height / 2 - 150);
  const scale = 1 + pulse * 0.04;
  ctxH.scale(scale, scale);
  ctxH.shadowColor = color;
  ctxH.shadowBlur = 10 + pulse * 10;
  ctxH.lineWidth = 1 + pulse * 0.7;
  ctxH.strokeStyle = color;
  ctxH.beginPath();

  for (const p of particles) {
    const len = 2.0 + 6.0 * pulse;
    const dx = Math.cos(p.angle) * len;
    const dy = Math.sin(p.angle) * len;
    ctxH.moveTo(p.x - dx / 2, p.y - dy / 2);
    ctxH.lineTo(p.x + dx / 2, p.y + dy / 2);
  }
  ctxH.stroke();
  ctxH.restore();

  // tim bay
  drawFlyingHearts();

  requestAnimationFrame(render);
}
render();

/* =====================================
   üéµ PH·∫¶N 5: ƒêI·ªÄU KHI·ªÇN NH·∫†C
===================================== */
const music = document.getElementById("bgMusic");
const musicControl = document.getElementById("musicControl");
const icon = document.getElementById("musicIcon");
let isPlaying = false; // b·∫Øt ƒë·∫ßu ·ªü tr·∫°ng th√°i t·∫Øt

musicControl.addEventListener("click", () => {
  if (isPlaying) {
    music.pause();
    icon.innerHTML = '<path d="M12 3v10.55A4 4 0 1 0 14 17V7h4V3h-6z"/>'; // play
  } else {
    music.play();
    icon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; // pause
  }
  isPlaying = !isPlaying;
});
</script>
</body>
</html>
